# 大众点评美食频道的爬虫

## 爬虫爬取思路
1. 分析大众点评美食频道的PC端网页与移动端网页,发现PC端网页采用字体替换方式进行反爬虫，且字体替换文件一天一换.而移动端网页没有这样的反爬机制，所以选择爬取移动端网页.
2. 分析每家店铺的评论，发现是由店铺id与评论页数构造出的post请求通过访问接口获得json数据来加载的.所以想要获取店铺下的评论信息，首先需要获得商铺id
3. 分析显示美食频道下所有店铺的网页，发现同样是通过ajax进行加载，利用抓包工具可以发现店铺的信息数据也是通过接口获取的，解析请求，可以轻松构造post
   请求获取json数据从而获得店铺信息，并将其存入数据库.
4. 从数据库中调出店铺信息中的店铺id与评论总数，通过店铺id和评论总数就可以构造出总共在这这家店铺下需要发送post请求获取json数据的次数.
5. 获取json数据，使用jsonpath_rw_ext解析内容，并存入数据库.

---
## 此项目包含俩个爬虫(shopinfo,dianping):
### shopinfo爬虫用于获取店铺的信息与id
`scrapy crawl shopinfo`
### dianping爬虫用于获取店铺下的所有评论信息
`scrapy crawl dianping`

---
## 数据库与存储:

 数据库采用sqlalachemy+mysql进行存储

---
## Settings设置:
`LOG_LEVEL ='INFO'`表示只显示INFO等级以上的信息

`JOBDIR = 'pause'` 表示开启中断续爬功能，并将状态存储于pause文件夹中

---
## MiddleWares:
添加了UserAgentmiddleware与Cookiesmiddleware来获取随机的header与cookies

## 配置重爬:
1. 在爬虫完成后，删除pause文件夹，也就是删除了之前保存的运行状态，重新运行爬虫即可开始重爬.
2. shopinfo爬虫重爬，重新遍历所有的url，获取所有的店铺信息，然后根据获得的数据在数据库中是否存在来进行判断存入还是抛弃.
3. dianping爬虫重爬是重新从数据库中提取店铺id构造请求,然后通过构造的请求遍历所有店铺，获取每家店铺内的评论信息，在存储进数据库前进行判断，根据某个字段的内容是否在数据库
   已经存在了来决定是否将此条数据存入数据库.我选择的是modified_at(评论最后一次修改时间)字段，这样如果同一条评论信息被评论人修改了内容，modified_at一定会
   发生变化，这样就可以同时保存新旧俩个版本。
